<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mecanizado Fácil</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="/manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Mecanizado Fácil</h1>
        <ul>
            <li><a href="Calculadora Avanzada de Engranajes.html">Calculadora Avanzada de Engranajes</a></li>
            <li><a href="Calculadora de Avances Para Freasadoras - Mecanizado Fácil.html">Calculadora de Avances Para Freasadoras - Mecanizado Fácil</a></li>
            <li><a href="Calculadora de Código G G76 (Fanuc) y Guía.html">Calculadora de Código G G76 (Fanuc) y Guía</a></li>
            <li><a href="Calculadora de Cuerdas y Coordenadas de Agujeros.html">Calculadora de Cuerdas y Coordenadas de Agujeros</a></li>
            <li><a href="Calculadora de Desarrollo de Cilindros y Conos.html">Calculadora de Desarrollo de Cilindros y Conos</a></li>
            <li><a href="Calculadora de Inclinación y Conicidad.html">Calculadora de Inclinación y Conicidad</a></li>
            <li><a href="Calculadora de Peso de Materiales.html">Calculadora de Peso de Materiales</a></li>
            <li><a href="Calculadora de Tolerancias ISO - Mecanizado Fácil.html">Calculadora de Tolerancias ISO - Mecanizado Fácil</a></li>
            <li><a href="Calculadora de Triángulos.html">Calculadora de Triángulos</a></li>
            <li><a href="Calculadora para Cabezal Divisor.html">Calculadora para Cabezal Divisor</a></li>
            <li><a href="Consejos para Principiantes en Mecanizado - Mecanizado Fácil.html">Consejos para Principiantes en Mecanizado - Mecanizado Fácil</a></li>
            <li><a href="Consultor de Roscas para Taller.html">Consultor de Roscas para Taller</a></li>
            <li><a href="Conversiones Técnicas para Talleres Mecánicos.html">Conversiones Técnicas para Talleres Mecánicos</a></li>
            <li><a href="Generador de Código G71 y Guía para Torno CNC.html">Generador de Código G71 y Guía para Torno CNC</a></li>
            <li><a href="Glosario.html">Glosario</a></li>
            <li><a href="Mecanizado Fácil - Calculadora de Chaveteros.html">Mecanizado Fácil - Calculadora de Chaveteros</a></li>
            <li><a href="Mecanizado Fácil - Calculadora de Inclinación de Cabezal.html">Mecanizado Fácil - Calculadora de Inclinación de Cabezal</a></li>
            <li><a href="Mecanizado Fácil - Suite Integral para Talleres Mecánicos.html">Mecanizado Fácil - Suite Integral para Talleres Mecánicos</a></li>
            <li><a href="Renuncia de Responsabilidad - Mecanizado Fácil.html">Renuncia de Responsabilidad - Mecanizado Fácil</a></li>
            <li><a href="Seguridad en Talleres de Mecanizado - Mecanizado Fácil.html">Seguridad en Talleres de Mecanizado - Mecanizado Fácil</a></li>
            <li><a href="Test de Seguridad en Mecanizado.html">Test de Seguridad en Mecanizado</a></li>
            <li><a href="ventas.html">Ventas</a></li>
        </ul>
    </div>

    <footer>
        <p>Hecho por Rivas Isaac google-sites.overhang127@passinbox.com</p>
    </footer>

    <!-- Botones y estado del caché movidos al final de la página -->
    <button id="cacheButton" onclick="cacheSiteOffline()">Guardar para uso sin conexión</button>
    <button id="installButton">Instalar como App</button>
    <div id="cacheStatus"></div>
    <script>
        let deferredPrompt; // Variable para almacenar el evento de instalación

        // Escuchar el evento beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevenir que la mini-barra de información aparezca automáticamente
            e.preventDefault();
            // Almacenar el evento para que pueda ser activado más tarde.
            deferredPrompt = e;
            // Mostrar el botón de instalación
            const installButton = document.getElementById('installButton');
            if (installButton) {
                installButton.style.display = 'block';
            }
            console.log('\'beforeinstallprompt\' event was fired.');
        });

        // Manejar el clic en el botón de instalación
        const installButton = document.getElementById('installButton');
        if (installButton) {
            installButton.addEventListener('click', async () => {
                // Ocultar el botón de instalación
                installButton.style.display = 'none';
                // Mostrar el prompt de instalación
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    // Esperar a que el usuario responda al prompt
                    const { outcome } = await deferredPrompt.userChoice;
                    // Opcionalmente, enviar analíticas para rastrear si el usuario aceptó el prompt
                    console.log(`User response to the install prompt: ${outcome}`);
                    // Ya usamos el prompt, no se puede usar de nuevo; lo limpiamos
                    deferredPrompt = null;
                }
            });
        }

        // Escuchar el evento appinstalled (opcional, para rastrear)
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            const installButton = document.getElementById('installButton');
             if (installButton) {
                installButton.style.display = 'none'; // Ocultar botón después de la instalación exitosa
             }
        });

        // Check if a service worker is already controlling the page on load
        document.addEventListener('DOMContentLoaded', () => {
            const cacheButton = document.getElementById('cacheButton');
            const cacheStatus = document.getElementById('cacheStatus');

            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                // Service worker is already active, likely cached
                cacheStatus.textContent = 'El sitio ya está guardado en caché y listo para uso sin conexión.';
                cacheStatus.style.backgroundColor = 'rgba(76, 175, 80, 0.8)'; /* Green background */
                cacheButton.textContent = 'Sitio guardado';
                cacheButton.disabled = true; // Disable the button
            }
        });
        // --- Existing cacheSiteOffline function ---
        // (Keep the existing cacheSiteOffline function here)
        // Make sure it's inside the same script block or accessible.
        // The diff below will show the function as it was, just adding the PWA logic around it.

        // Existing cacheSiteOffline function:
        function cacheSiteOffline() {
            const cacheButton = document.getElementById('cacheButton');
            const cacheStatus = document.getElementById('cacheStatus');

            if ('serviceWorker' in navigator) {
                cacheStatus.textContent = 'Guardando sitio en caché... Por favor, espera.';
                cacheStatus.style.backgroundColor = 'rgba(255, 152, 0, 0.8)'; /* Orange background for status */
                cacheStatus.style.color = '#000'; /* Dark text for orange background */
                cacheButton.disabled = true;

                navigator.serviceWorker.register('./sw.js') // Asegúrate que la ruta a sw.js sea correcta
                    .then(registration => {
                        console.log('ServiceWorker registrado con éxito, scope:', registration.scope);

                        if (registration.installing) {
                            registration.installing.addEventListener('statechange', () => {
                                if (registration.active) {
                                    cacheStatus.textContent = '¡Sitio guardado en caché! Ahora puedes usarlo sin conexión.'; // Keep original success message
                                    cacheStatus.style.color = 'green';
                                    cacheButton.textContent = 'Sitio guardado';
                                }
                            });
                        } else if (registration.active) {
                             cacheStatus.textContent = 'El sitio ya está guardado en caché y listo para uso sin conexión.';
                             cacheStatus.style.backgroundColor = 'rgba(76, 175, 80, 0.8)'; /* Green background */
                             cacheButton.textContent = 'Sitio guardado'; // Keep original success text
                        } else { // Si no está instalando ni activo, pero el registro fue exitoso, esperamos el cambio de estado
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                     if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        cacheStatus.textContent = '¡Sitio guardado en caché! Ahora puedes usarlo sin conexión.';                                        
                                        cacheStatus.style.backgroundColor = 'rgba(76, 175, 80, 0.8)'; /* Green background */
                                        cacheButton.textContent = 'Sitio guardado';
                                     }
                                });
                            });
                        }
                    })
                    .catch(error => {
                        console.log('Fallo en el registro del ServiceWorker:', error);
                        cacheStatus.textContent = 'Error al guardar el sitio en caché. Inténtalo de nuevo.';
                        cacheStatus.style.backgroundColor = 'rgba(244, 67, 54, 0.8)'; /* Red background */
                        cacheButton.disabled = false;
                    });
            } else {
                cacheStatus.textContent = 'Tu navegador no soporta la funcionalidad para guardar offline.';
                cacheStatus.style.color = 'red';
                cacheButton.style.display = 'none';
            }
        }
    </script>
</body>
</html>
